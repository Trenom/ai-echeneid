name: Setup VPS (run once)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 120s
          script: |
            set -e
            DOMAIN="ai.echeneid.com"
            WEBROOT="/var/www/$DOMAIN"
            REPO="https://github.com/Trenom/ai-echeneid.git"

            echo "=== 1. Crear directorio web ==="
            mkdir -p "$WEBROOT"

            echo "=== 2. Clonar o actualizar el repo ==="
            if [ -d "$WEBROOT/.git" ]; then
              cd "$WEBROOT" && git pull origin main
            else
              git clone "$REPO" "$WEBROOT"
            fi

            echo "=== 3. Configurar Nginx ==="
            cat > "/etc/nginx/sites-available/$DOMAIN" << 'NGINXEOF'
            server {
                listen 80;
                server_name ai.echeneid.com;
                root /var/www/ai.echeneid.com;
                index index.html;
                location / { try_files $uri $uri/ =404; }
                location ~* \.(css|js|png|jpg|svg|ico|woff2?)$ {
                    expires 30d;
                    add_header Cache-Control "public, immutable";
                }
                add_header X-Frame-Options "SAMEORIGIN";
                add_header X-Content-Type-Options "nosniff";
            }
            NGINXEOF

            ln -sf "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
            nginx -t
            systemctl reload nginx
            echo "Nginx OK"

            echo "=== 4. SSL con Certbot ==="
            certbot --nginx -d "$DOMAIN" \
              --non-interactive --agree-tos \
              -m wenceslao.maislin@gmail.com \
              --redirect
            echo "SSL OK"

            echo "=== Setup completo: https://$DOMAIN ==="